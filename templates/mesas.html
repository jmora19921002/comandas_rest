{% extends "base.html" %}
{% block title %}Gestión de Mesas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalMesas">Seleccionar Mesa</button>
        </div>
        
        <h2>Grupos</h2>
        <div class="mb-3">
            <!-- Organizamos los grupos en 4 columnas -->
            <div class="row">
                {% for grupo in grupos | batch((grupos|length / 4)|round(0, 'ceil')|int) %}
                <div class="col-md-3">
                    {% for g in grupo %}
                    <button type="button" class="btn btn-outline-secondary mb-2 w-100" 
                            data-bs-toggle="modal" data-bs-target="#modalGrupo{{ g.id }}">
                        {{ g.nombre }}
                    </button>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        {% if not mesas %}
        <div class="alert alert-info" role="alert">
            No hay mesas disponibles. Por favor, configure las mesas en el sistema.
        </div>
        {% endif %}
        
        <div class="alert alert-warning" role="alert">
            <strong>Nota:</strong> Asegúrese de seleccionar una mesa antes de agregar items a la comanda.
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="sticky-top" style="top: 20px;">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Comanda - Mesa: <span id="mesa-seleccionada">Ninguna</span></h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="servicio-tipo" class="form-label">Tipo de Servicio</label>
                        <select class="form-select" id="servicio-tipo">
                            <option value="local">Comer en Local</option>
                            <option value="delivery">Delivery</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table class="table" id="tabla-comanda">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="detalle-comanda">
                                <!-- Aquí se agregarán los items dinámicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3">Total:</th>
                                    <th id="total-comanda">$0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button id="btn-imprimir" class="btn btn-info" disabled>
                            <i class="bi bi-printer"></i> <span id="btn-imprimir-text">Imprimir Comanda</span>
                        </button>
                        <button id="btn-guardar" class="btn btn-success" disabled>
                            <i class="bi bi-save"></i> <span id="btn-guardar-text">Guardar Comanda</span>
                        </button>
                        <button id="btn-totalizar" class="btn btn-warning" disabled>
                            <i class="bi bi-cash"></i> <span id="btn-totalizar-text">Totalizar y Cerrar</span>
                        </button>
                        <button id="btn-cerrar" class="btn btn-danger" disabled>
                            <i class="bi bi-x-circle"></i> Cerrar Comanda
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para selección de mesas -->
<div class="modal fade" id="modalMesas" tabindex="-1" aria-labelledby="modalMesasLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMesasLabel">Seleccionar Mesa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="mesas-container">
                    {% for mesa in mesas %}
                    <div class="col-md-3 mb-3">
                        <div class="card mesa-card text-center 
                            {% if mesa.estatus == 'libre' %}bg-success text-white
                            {% elif mesa.estatus == 'ocupada' %}bg-warning{% endif %}"
                            data-id="{{ mesa.id }}" data-nombre="{{ mesa.nombre }}" data-estatus="{{ mesa.estatus }}">
                            <div class="card-body">
                                <h5 class="card-title">{{ mesa.nombre }}</h5>
                                <p class="card-text">{{ mesa.estatus|capitalize }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales para cada grupo de productos -->
{% for grupo in grupos %}
<div class="modal fade" id="modalGrupo{{ grupo.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ grupo.nombre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    {% for producto in productos if producto.grupo_id == grupo.id %}
                    <div class="col-md-3 mb-3 producto-card" data-id="{{ producto.id }}" data-name="{{ producto.nombre }}" 
                         data-precio="{{ producto.precio_venta }}" data-grupo="{{ producto.grupo_id }}">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">{{ producto.nombre }}</h5>
                                <p class="card-text">${{ "%.2f"|format(producto.precio_venta) }}</p>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm producto-nota" placeholder="Nota (opcional)">
                                </div>
                                <button class="btn btn-primary btn-sm agregar-producto">Agregar</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal para la vista previa de impresión -->
<div class="modal fade" id="modalImpresion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vista Previa de Impresión</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenido-impresion">
                <!-- Aquí se generará el contenido para imprimir -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="iniciarImpresionTotalizacion()">Imprimir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let comanda = {
    mesa_id: null,
    comanda_id: null,
    items: [],
    total: 0,
    servicio: 'local'
};

document.addEventListener('DOMContentLoaded', function() {
    // Delegación de eventos para los botones de mesas
    document.getElementById('mesas-container').addEventListener('click', function(e) {
        const card = e.target.closest('.mesa-card');
        if (card) {
            console.log('Mesa clickeada:', card.dataset);
            const mesaId = card.dataset.id;
            const mesaNombre = card.dataset.nombre;
            const mesaEstatus = card.dataset.estatus;
            seleccionarMesa(mesaId, mesaNombre, mesaEstatus);
        }
    });

    // Mostrar modal de mesas al cargar
    const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
    modalMesas.show();

    // Eventos para los botones de grupos
    document.querySelectorAll('.grupo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.grupo-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const grupoId = this.dataset.grupo;
            filtrarItemsPorGrupo(grupoId);
        });
    });

    // Eventos para agregar productos desde los modales de grupos
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target.classList.contains('agregar-producto')) {
                if (!comanda.mesa_id) {
                    alert('Por favor seleccione una mesa primero');
                    const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
                    modalMesas.show();
                    return;
                }
                
                const card = e.target.closest('.producto-card');
                if (card) {
                    const productoId = parseInt(card.dataset.id);
                    const nombre = card.dataset.name;
                    const precio = parseFloat(card.dataset.precio);
                    const grupoId = card.dataset.grupo;
                    
                    console.log('Datos del producto:', { productoId, nombre, precio, grupoId }); // Debug
                    
                    if (!productoId || !nombre || isNaN(precio)) {
                        console.error('Datos inválidos del producto:', card.dataset);
                        return;
                    }
                    
                    agregarProducto(productoId, nombre, precio, grupoId);
                    
                    // Cerrar el modal después de agregar el producto
                    const modalInstance = bootstrap.Modal.getInstance(this);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
            }
        });
    });

    // Botón guardar comanda
    document.getElementById('btn-guardar').addEventListener('click', guardarComanda);
    
    // Botón cerrar comanda
    document.getElementById('btn-cerrar').addEventListener('click', cerrarComanda);

    // Botón imprimir comanda
    document.getElementById('btn-imprimir').addEventListener('click', function() {
        imprimirComanda(false);
    });

    // Botón totalizar comanda
    document.getElementById('btn-totalizar').addEventListener('click', totalizarComanda);
});

function filtrarItemsPorGrupo(grupoId) {
    const items = document.querySelectorAll('.item-card');
    
    items.forEach(item => {
        if (grupoId === 'todos' || item.dataset.grupo === grupoId) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function seleccionarMesa(mesaId, mesaNombre, mesaEstatus) {
    console.log('Seleccionando mesa:', { mesaId, mesaNombre, mesaEstatus }); // Debug
    
    // Verificar si hay una comanda activa en otra mesa
    if (comanda.mesa_id && comanda.mesa_id !== mesaId) {
        if (confirm('Hay una comanda activa en otra mesa. ¿Desea guardar la comanda actual y cambiar a la nueva mesa?')) {
            // Guardar la comanda actual antes de cambiar
            guardarComandaYCambiarMesa(mesaId, mesaNombre, mesaEstatus);
            return;
        } else {
            return;
        }
    }
    
    // Si la mesa está ocupada, cargar la comanda existente
    if (mesaEstatus === 'ocupada') {
        cargarComandaExistente(mesaId, mesaNombre);
    } else {
        // Si la mesa está libre, crear una nueva comanda
        comanda = {
            mesa_id: mesaId,
            comanda_id: null,
            items: [],
            total: 0,
            servicio: 'local'
        };
        
        // Actualizar la interfaz
        document.getElementById('mesa-seleccionada').textContent = mesaNombre;
        document.getElementById('detalle-comanda').innerHTML = '';
        document.getElementById('total-comanda').textContent = '$0.00';
        document.getElementById('servicio-tipo').value = 'local';
        
        // Habilitar botones
        document.getElementById('btn-guardar').disabled = false;
        document.getElementById('btn-imprimir').disabled = false;
        document.getElementById('btn-totalizar').disabled = false;
        document.getElementById('btn-cerrar').disabled = false;
        
        // Actualizar el estado visual de la mesa
        const mesaCard = document.querySelector(`.mesa-card[data-id="${mesaId}"]`);
        if (mesaCard) {
            mesaCard.classList.remove('bg-success', 'bg-warning', 'text-white');
            mesaCard.classList.add('bg-warning');
            mesaCard.querySelector('.card-text').textContent = 'Ocupada';
            mesaCard.dataset.estatus = 'ocupada';
        }
        
        // Actualizar el estado de todas las mesas
        actualizarEstadoMesas();
    }
    
    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalMesas'));
    if (modal) {
        modal.hide();
    }
}

// Nueva función para guardar la comanda actual y cambiar de mesa
async function guardarComandaYCambiarMesa(nuevaMesaId, nuevaMesaNombre, nuevaMesaEstatus) {
    try {
        console.log('Guardando comanda actual antes de cambiar de mesa...'); // Debug
        
        // Verificar si hay items para guardar
        if (!comanda.items || comanda.items.length === 0) {
            console.log('No hay items para guardar, cambiando directamente de mesa'); // Debug
            cambiarAMesa(nuevaMesaId, nuevaMesaNombre, nuevaMesaEstatus);
            return;
        }
        
        await guardarComandaSinLimpiar();
        console.log('Comanda guardada exitosamente con ID:', comanda.comanda_id); // Debug
        
        // Actualizar el estado de las mesas
        await actualizarEstadoMesas();
        
        // Ahora cambiar a la nueva mesa
        cambiarAMesa(nuevaMesaId, nuevaMesaNombre, nuevaMesaEstatus);
        
    } catch (error) {
        console.error('Error al guardar la comanda:', error);
        window.mostrarNotificacion('Error al guardar la comanda: ' + error.message, 'danger');
        
        // Si falla el guardado, preguntar si quiere cambiar de mesa de todas formas
        if (confirm('Error al guardar la comanda. ¿Desea cambiar de mesa de todas formas? (Se perderán los datos no guardados)')) {
            cambiarAMesa(nuevaMesaId, nuevaMesaNombre, nuevaMesaEstatus);
        }
    }
}

// Función auxiliar para cambiar a una nueva mesa
function cambiarAMesa(mesaId, mesaNombre, mesaEstatus) {
    console.log('Cambiando a nueva mesa:', { mesaId, mesaNombre, mesaEstatus }); // Debug
    
    // Si la mesa está ocupada, cargar la comanda existente
    if (mesaEstatus === 'ocupada') {
        cargarComandaExistente(mesaId, mesaNombre);
    } else {
        // Si la mesa está libre, crear una nueva comanda
        comanda = {
            mesa_id: mesaId,
            comanda_id: null,
            items: [],
            total: 0,
            servicio: 'local'
        };
        
        // Actualizar la interfaz
        document.getElementById('mesa-seleccionada').textContent = mesaNombre;
        document.getElementById('detalle-comanda').innerHTML = '';
        document.getElementById('total-comanda').textContent = '$0.00';
        document.getElementById('servicio-tipo').value = 'local';
        
        // Habilitar botones
        document.getElementById('btn-guardar').disabled = false;
        document.getElementById('btn-imprimir').disabled = false;
        document.getElementById('btn-totalizar').disabled = false;
        document.getElementById('btn-cerrar').disabled = false;
        
        // Actualizar el estado visual de la mesa
        const mesaCard = document.querySelector(`.mesa-card[data-id="${mesaId}"]`);
        if (mesaCard) {
            mesaCard.classList.remove('bg-success', 'bg-warning', 'text-white');
            mesaCard.classList.add('bg-warning');
            mesaCard.querySelector('.card-text').textContent = 'Ocupada';
            mesaCard.dataset.estatus = 'ocupada';
        }
        
        // Actualizar el estado de todas las mesas
        actualizarEstadoMesas();
    }
    
    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalMesas'));
    if (modal) {
        modal.hide();
    }
}

function cargarComandaExistente(mesaId, mesaNombre) {
    console.log('Cargando comanda existente para la mesa:', mesaId);
    
    fetch(`/api/comanda?mesa_id=${mesaId}`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    // Si no hay comanda, crear una nueva
                    console.log('No se encontró comanda activa, creando nueva...');
                    return { comanda: null, detalles: [] };
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data); // Debug
            
            if (data.comanda) {
                console.log('Comanda encontrada:', data.comanda); // Debug
                console.log('Detalles encontrados:', data.detalles); // Debug
                
                // Asegurarse de que los detalles existan
                const detalles = data.detalles || [];
                
                comanda = {
                    mesa_id: mesaId,
                    comanda_id: data.comanda.id,
                    items: detalles.map(d => {
                        console.log('Procesando detalle:', d); // Debug
                        return {
                            item_id: d.item_id,
                            nombre: d.nombre || 'Producto sin nombre',
                            precio: parseFloat(d.precio || 0),
                            cantidad: parseInt(d.cantidad || 0),
                            total: parseFloat(d.total || 0),
                            grupo_codigo: d.grupo_codigo || '',
                            impreso: d.impreso || '',
                            estatus: d.estatus || 'pendiente',
                            nota: d.nota || '',
                            cantidad_impresa: parseInt(d.cantidad_impresa || 0)
                        };
                    }),
                    total: parseFloat(data.comanda.total || 0),
                    servicio: data.comanda.servicio || 'local'
                };
                
                console.log('Comanda procesada:', comanda); // Debug
                
                // Actualizar la interfaz
                actualizarVistaComanda();
                document.getElementById('mesa-seleccionada').textContent = mesaNombre;
                document.getElementById('servicio-tipo').value = comanda.servicio;
                document.getElementById('btn-guardar').disabled = false;
                document.getElementById('btn-imprimir').disabled = comanda.items.length === 0;
                document.getElementById('btn-totalizar').disabled = comanda.items.length === 0;
                document.getElementById('btn-cerrar').disabled = false;
            } else {
                console.warn('La mesa está ocupada pero no tiene comanda activa');
                
                // Crear una nueva comanda para esta mesa
                comanda = {
                    mesa_id: mesaId,
                    comanda_id: null,
                    items: [],
                    total: 0,
                    servicio: 'local'
                };
                
                document.getElementById('mesa-seleccionada').textContent = mesaNombre;
                document.getElementById('detalle-comanda').innerHTML = '';
                document.getElementById('total-comanda').textContent = '$0.00';
                document.getElementById('servicio-tipo').value = 'local';
                document.getElementById('btn-guardar').disabled = false;
                document.getElementById('btn-imprimir').disabled = true;
                document.getElementById('btn-totalizar').disabled = true;
                document.getElementById('btn-cerrar').disabled = true;
            }
            
            // Cerrar el modal de mesas de manera segura
            const modalMesas = document.getElementById('modalMesas');
            if (modalMesas) {
                const modalInstance = bootstrap.Modal.getInstance(modalMesas);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
        })
        .catch(error => {
            console.error('Error al cargar la comanda:', error);
            window.mostrarNotificacion('Error al cargar la comanda: ' + error.message, 'danger');
            
            // En caso de error, crear una nueva comanda
            comanda = {
                mesa_id: mesaId,
                comanda_id: null,
                items: [],
                total: 0,
                servicio: 'local'
            };
            
            document.getElementById('mesa-seleccionada').textContent = mesaNombre;
            document.getElementById('detalle-comanda').innerHTML = '';
            document.getElementById('total-comanda').textContent = '$0.00';
            document.getElementById('servicio-tipo').value = 'local';
            document.getElementById('btn-guardar').disabled = false;
            document.getElementById('btn-imprimir').disabled = true;
            document.getElementById('btn-totalizar').disabled = true;
            document.getElementById('btn-cerrar').disabled = true;
        });
}

function cancelarComanda() {
    if (!comanda || !comanda.comanda_id) {
        // Si no hay comanda_id, simplemente limpiar la interfaz
        comanda = {
            mesa_id: null,
            comanda_id: null,
            items: [],
            total: 0,
            servicio: 'local'
        };
        
        // Limpiar la interfaz
        document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
        document.getElementById('detalle-comanda').innerHTML = '';
        document.getElementById('total-comanda').textContent = '$0.00';
        document.getElementById('servicio-tipo').value = 'local';
        
        // Deshabilitar botones
        document.getElementById('btn-guardar').disabled = true;
        document.getElementById('btn-imprimir').disabled = true;
        document.getElementById('btn-totalizar').disabled = true;
        document.getElementById('btn-cerrar').disabled = true;
        
        // Actualizar el estado de todas las mesas
        actualizarEstadoMesas();
        
        return;
    }
    
    fetch(`/api/comandas/${comanda.comanda_id}/cancelar`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar el estado visual de la mesa
            const mesaCard = document.querySelector(`.mesa-card[data-id="${comanda.mesa_id}"]`);
            if (mesaCard) {
                mesaCard.classList.remove('bg-success', 'bg-warning');
                mesaCard.classList.add('bg-success');
                mesaCard.querySelector('.card-text').textContent = 'Libre';
                mesaCard.dataset.estatus = 'libre';
            }
            
            // Actualizar el estado de todas las mesas
            actualizarEstadoMesas();
            
            window.mostrarNotificacion('Comanda cancelada correctamente', 'success');
            
            // Limpiar la comanda actual
            comanda = {
                mesa_id: null,
                comanda_id: null,
                items: [],
                total: 0,
                servicio: 'local'
            };
            
            // Limpiar la interfaz
            document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
            document.getElementById('detalle-comanda').innerHTML = '';
            document.getElementById('total-comanda').textContent = '$0.00';
            document.getElementById('servicio-tipo').value = 'local';
            
            // Deshabilitar botones
            document.getElementById('btn-guardar').disabled = true;
            document.getElementById('btn-imprimir').disabled = true;
            document.getElementById('btn-totalizar').disabled = true;
            document.getElementById('btn-cerrar').disabled = true;
            
            // Mostrar el modal de selección de mesa
            const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
            modalMesas.show();
        } else {
            throw new Error(data.error || 'Error al cancelar la comanda');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.mostrarNotificacion('Error al cancelar comanda: ' + error.message, 'danger');
    });
}

function editarCantidad(itemId, nuevaCantidad) {
    if (nuevaCantidad < 1) {
        eliminarItem(itemId);
        return;
    }
    
    const item = comanda.items.find(item => item.item_id === itemId);
    if (item) {
        item.cantidad = nuevaCantidad;
        actualizarVistaComanda();
    }
}

function eliminarItem(itemId) {
    comanda.items = comanda.items.filter(item => item.item_id !== itemId);
    actualizarVistaComanda();
}

function agregarProducto(productoId, nombre, precio, grupoId) {
    console.log('Agregando producto:', { productoId, nombre, precio, grupoId }); // Debug
    
    if (!comanda) {
        comanda = {
            mesa_id: null,
            comanda_id: null,
            items: [],
            total: 0,
            servicio: 'local'
        };
    }
    
    // Validar datos
    if (!productoId || !nombre || isNaN(precio)) {
        console.error('Datos inválidos:', { productoId, nombre, precio, grupoId });
        return;
    }
    
    // Obtener la nota del input
    const notaInput = document.querySelector(`.producto-card[data-id="${productoId}"] .producto-nota`);
    const nota = notaInput ? notaInput.value.trim() : '';
    
    // Verificar si el producto ya existe en la comanda
    const productoExistente = comanda.items.find(item => item.item_id === productoId);
    
    if (productoExistente) {
        productoExistente.cantidad += 1;
        if (nota) {
            productoExistente.nota = nota;
        }
    } else {
        const nuevoProducto = {
            item_id: productoId,
            nombre: nombre,
            precio: parseFloat(precio),
            cantidad: 1,
            grupo_codigo: grupoId,
            nota: nota
        };
        console.log('Nuevo producto:', nuevoProducto); // Debug
        comanda.items.push(nuevoProducto);
    }
    
    // Limpiar la nota después de agregar
    if (notaInput) {
        notaInput.value = '';
    }
    
    actualizarVistaComanda();
    
    // Habilitar botones cuando hay productos
    document.getElementById('btn-imprimir').disabled = false;
    document.getElementById('btn-totalizar').disabled = false;
    
    // Cerrar el modal correctamente
    if (grupoId) {
        const modalId = `modalGrupo${grupoId}`;
        const modal = document.getElementById(modalId);
        if (modal) {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
        }
    }
}

function actualizarVistaComanda() {
    const detalleComanda = document.getElementById('detalle-comanda');
    detalleComanda.innerHTML = '';
    
    if (!comanda || !comanda.items || comanda.items.length === 0) {
        detalleComanda.innerHTML = '<tr><td colspan="5" class="text-center">No hay productos en la comanda</td></tr>';
        document.getElementById('total-comanda').textContent = '$0.00';
        // Deshabilitar botones cuando no hay productos
        document.getElementById('btn-imprimir').disabled = true;
        document.getElementById('btn-totalizar').disabled = true;
        return;
    }
    
    let total = 0;
    comanda.items.forEach(item => {
        console.log('Procesando producto:', item); // Debug
        
        const itemTotal = (parseFloat(item.precio) || 0) * (parseInt(item.cantidad) || 0);
        total += itemTotal;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                ${item.nombre || 'Producto sin nombre'}
                ${item.nota ? `<br><small class="text-muted">Nota: ${item.nota}</small>` : ''}
            </td>
            <td class="text-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary" onclick="editarCantidad(${item.item_id}, ${(parseInt(item.cantidad) || 0) - 1})">-</button>
                    <span class="btn btn-outline-secondary disabled">${item.cantidad || 0}</span>
                    <button class="btn btn-outline-secondary" onclick="editarCantidad(${item.item_id}, ${(parseInt(item.cantidad) || 0) + 1})">+</button>
                </div>
            </td>
            <td class="text-end">$${(parseFloat(item.precio) || 0).toFixed(2)}</td>
            <td class="text-end">$${itemTotal.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="eliminarItem(${item.item_id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        detalleComanda.appendChild(tr);
    });
    
    document.getElementById('total-comanda').textContent = `$${total.toFixed(2)}`;
    
    // Habilitar botones cuando hay productos
    document.getElementById('btn-imprimir').disabled = false;
    document.getElementById('btn-totalizar').disabled = false;
}

// Función para mostrar estado de carga en botones
function mostrarCarga(buttonId, texto, isLoading = true) {
    const button = document.getElementById(buttonId);
    const textSpan = document.getElementById(buttonId + '-text');
    
    if (isLoading) {
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${texto}`;
    } else {
        button.disabled = false;
        if (textSpan) {
            textSpan.textContent = texto;
        }
        // Restaurar el ícono original
        if (buttonId === 'btn-imprimir') {
            button.innerHTML = `<i class="bi bi-printer"></i> <span id="btn-imprimir-text">${texto}</span>`;
        } else if (buttonId === 'btn-guardar') {
            button.innerHTML = `<i class="bi bi-save"></i> <span id="btn-guardar-text">${texto}</span>`;
        } else if (buttonId === 'btn-totalizar') {
            button.innerHTML = `<i class="bi bi-cash"></i> <span id="btn-totalizar-text">${texto}</span>`;
        }
    }
}

// Función para guardar comanda sin limpiar la pantalla
async function guardarComandaSinLimpiar() {
    if (!comanda || !comanda.items || comanda.items.length === 0) {
        throw new Error('No hay productos en la comanda para guardar.');
    }

    const servicio = document.getElementById('servicio-tipo').value;
    
    // Preparar los datos de la comanda
    const comandaData = {
        mesa_id: comanda.mesa_id,
        comanda_id: comanda.comanda_id || null,
        servicio: servicio,
        items: comanda.items.map(item => ({
            item_id: item.item_id,
            cantidad: parseInt(item.cantidad) || 0,
            precio: parseFloat(item.precio) || 0,
            nota: item.nota || '',
            grupo_codigo: item.grupo_codigo || '',
            nombre: item.nombre || ''
        }))
    };

    console.log('Enviando datos de comanda:', JSON.stringify(comandaData, null, 2)); // Debug detallado

    const response = await fetch('/api/comanda', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(comandaData)
    });

    const data = await response.json();
    
    if (!response.ok) {
        throw new Error(data.error || data.message || `Error del servidor: ${response.status}`);
    }
    
    if (!data.success) {
        throw new Error(data.error || 'Error al guardar la comanda');
    }

    // Actualizar el comanda_id si es una nueva comanda
    if (!comanda.comanda_id) {
        comanda.comanda_id = data.comanda_id;
        console.log('Nueva comanda guardada con ID:', comanda.comanda_id); // Debug
    } else {
        console.log('Comanda existente actualizada con ID:', comanda.comanda_id); // Debug
    }

    return data;
}

// Función para guardar comanda (con limpieza de pantalla)
async function guardarComanda() {
    if (!comanda || !comanda.items || comanda.items.length === 0) {
        alert('No hay productos en la comanda para guardar.');
        return;
    }

    try {
        mostrarCarga('btn-guardar', 'Guardando...', true);
        
        await guardarComandaSinLimpiar();
        
        window.mostrarNotificacion('Comanda guardada correctamente. Pantalla limpiada.', 'success');
        
        // Actualizar el estado visual de la mesa
        const mesaCard = document.querySelector(`.mesa-card[data-id="${comanda.mesa_id}"]`);
        if (mesaCard) {
            mesaCard.classList.remove('bg-success', 'bg-warning');
            mesaCard.classList.add('bg-warning');
            mesaCard.querySelector('.card-text').textContent = 'Ocupada';
            mesaCard.dataset.estatus = 'ocupada';
        }
        
        // Limpiar la comanda actual
        comanda = {
            mesa_id: null,
            comanda_id: null,
            items: [],
            total: 0,
            servicio: 'local'
        };
        
        // Limpiar la interfaz
        document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
        document.getElementById('detalle-comanda').innerHTML = '';
        document.getElementById('total-comanda').textContent = '$0.00';
        document.getElementById('servicio-tipo').value = 'local';
        
        // Deshabilitar botones
        document.getElementById('btn-guardar').disabled = true;
        document.getElementById('btn-imprimir').disabled = true;
        document.getElementById('btn-totalizar').disabled = true;
        document.getElementById('btn-cerrar').disabled = true;
        
        // Mostrar el modal de selección de mesa
        const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
        modalMesas.show();
    } catch (error) {
        console.error('Error completo:', error);
        console.error('Stack trace:', error.stack);
        window.mostrarNotificacion('Error al guardar la comanda: ' + error.message, 'danger');
    } finally {
        mostrarCarga('btn-guardar', 'Guardar Comanda', false);
    }
}

// Función para cerrar comanda
function cerrarComanda() {
    if (!confirm('¿Está seguro de cancelar esta comanda?')) {
        return;
    }
    
    if (!comanda || !comanda.comanda_id) {
        window.mostrarNotificacion('No hay una comanda activa para cancelar', 'warning');
        return;
    }
    
    fetch(`/api/comandas/${comanda.comanda_id}/cancelar`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar el estado visual de la mesa
            const mesaCard = document.querySelector(`.mesa-card[data-id="${comanda.mesa_id}"]`);
            if (mesaCard) {
                mesaCard.classList.remove('bg-success', 'bg-warning');
                mesaCard.classList.add('bg-success');
                mesaCard.querySelector('.card-text').textContent = 'Libre';
                mesaCard.dataset.estatus = 'libre';
            }
            
            // Actualizar el estado de todas las mesas
            actualizarEstadoMesas();
            
            window.mostrarNotificacion('Comanda cancelada correctamente', 'success');
            
            // Limpiar la comanda actual
            comanda = {
                mesa_id: null,
                comanda_id: null,
                items: [],
                total: 0,
                servicio: 'local'
            };
            
            // Limpiar la interfaz
            document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
            document.getElementById('detalle-comanda').innerHTML = '';
            document.getElementById('total-comanda').textContent = '$0.00';
            document.getElementById('servicio-tipo').value = 'local';
            
            // Deshabilitar botones
            document.getElementById('btn-guardar').disabled = true;
            document.getElementById('btn-imprimir').disabled = true;
            document.getElementById('btn-totalizar').disabled = true;
            document.getElementById('btn-cerrar').disabled = true;
            
            // Mostrar el modal de selección de mesa
            const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
            modalMesas.show();
        } else {
            throw new Error(data.error || 'Error al cancelar la comanda');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.mostrarNotificacion('Error al cancelar comanda: ' + error.message, 'danger');
    });
}

async function imprimirComanda(esTotalizacion = false) {
    if (!comanda || !comanda.items || comanda.items.length === 0) {
        alert('No hay productos en la comanda para imprimir.');
        return;
    }

    try {
        mostrarCarga('btn-imprimir', 'Guardando e imprimiendo...', true);
        
        // 1. PRIMERO: Guardar la comanda en la base de datos
        console.log('Guardando comanda antes de imprimir...'); // Debug
        
        await guardarComandaSinLimpiar();
        console.log('Comanda guardada exitosamente'); // Debug
        
        // 2. SEGUNDO: Obtener las asignaciones de impresoras
        const responseMappings = await fetch('/api/printer_mappings');
        const printerMappings = await responseMappings.json();

        // Crear un mapa de grupo_id a impresora
        const printerMap = {};
        printerMappings.forEach(mapping => {
            printerMap[mapping.grupo_id] = mapping.impresora;
        });

        // 3. TERCERO: Filtrar solo los productos que necesitan ser impresos
        const itemsToPrint = comanda.items.filter(item => {
            // Si es totalización, imprimir todo
            if (esTotalizacion) return true;
            
            // Si no tiene cantidad impresa, imprimir todo
            if (!item.cantidad_impresa) return true;
            
            // Si la cantidad actual es mayor que la cantidad impresa, imprimir la diferencia
            return parseInt(item.cantidad) > parseInt(item.cantidad_impresa);
        });

        if (itemsToPrint.length === 0 && !esTotalizacion) {
            alert('No hay nuevos productos para imprimir.');
            return;
        }

        // 4. CUARTO: Agrupar los ítems por impresora (no por grupo)
        const itemsGroupedByPrinter = {};
        itemsToPrint.forEach(item => {
            const grupoId = item.grupo_codigo || 'default';
            const printerInfo = printerMap[grupoId];
            
            // Determinar la clave de la impresora
            let printerKey = 'default';
            if (printerInfo) {
                printerKey = `${printerInfo.tipo}_${printerInfo.nombre || printerInfo.ip}`;
            }
            
            if (!itemsGroupedByPrinter[printerKey]) {
                itemsGroupedByPrinter[printerKey] = {
                    items: [],
                    printerInfo: printerInfo,
                    grupos: new Set()
                };
            }
            
            // Calcular la cantidad a imprimir
            let cantidadAImprimir = parseInt(item.cantidad);
            if (!esTotalizacion && item.cantidad_impresa) {
                cantidadAImprimir = parseInt(item.cantidad) - parseInt(item.cantidad_impresa);
            }
            
            // Asegurarnos de que tenemos todos los datos necesarios
            const itemData = {
                nombre: item.nombre || item.item_nombre || item.descripcion || 'Producto sin nombre',
                cantidad: cantidadAImprimir,
                precio: parseFloat(item.precio) || 0.00,
                item_id: item.item_id,
                nota: item.nota || '',
                cantidad_impresa: item.cantidad_impresa || 0,
                grupo_codigo: grupoId
            };
            
            console.log('Producto a imprimir:', itemData); // Debug
            itemsGroupedByPrinter[printerKey].items.push(itemData);
            itemsGroupedByPrinter[printerKey].grupos.add(grupoId);
        });

        // 5. QUINTO: Iterar sobre las impresoras y enviar los tickets
        for (const printerKey in itemsGroupedByPrinter) {
            const printerData = itemsGroupedByPrinter[printerKey];
            const itemsToPrint = printerData.items;
            const printerInfo = printerData.printerInfo;
            const grupos = Array.from(printerData.grupos);

            if (!printerInfo && printerKey !== 'default') {
                console.warn(`Saltando impresión para la impresora: ${printerKey} ya que no tiene configuración válida.`);
                continue;
            }

            // Obtener nombres de grupos para el ticket
            const grupoNombres = grupos.map(grupoId => {
                const grupoObj = printerMappings.find(m => m.grupo_id === grupoId);
                return grupoObj ? grupoObj.grupo_nombre : (grupoId === 'default' ? 'Sin Grupo' : grupoId);
            }).join(', ');

            try {
                // Obtener el tipo de servicio
                const servicio = document.getElementById('servicio-tipo').value;
                
                // Llamar al backend para generar el contenido del ticket en texto plano
                const generateTicketResponse = await fetch('/api/generar_ticket_plain_text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mesa_nombre: document.getElementById('mesa-seleccionada').textContent,
                        items: itemsToPrint,
                        grupo_nombre: grupoNombres,
                        es_totalizacion: esTotalizacion,
                        servicio: servicio
                    })
                });

                if (!generateTicketResponse.ok) {
                    throw new Error(`Error al generar ticket: ${generateTicketResponse.statusText}`);
                }

                const generateTicketData = await generateTicketResponse.json();
                if (!generateTicketData.success) {
                    throw new Error(generateTicketData.message || 'Error al generar el ticket');
                }

                const ticketContent = generateTicketData.ticket_content;

                // Determinar qué impresora usar
                let targetPrinterName = null;
                let targetPrinterType = null;
                let targetPrinterIp = null;
                let targetPrinterPort = null;

                if (printerInfo) {
                    targetPrinterName = printerInfo.nombre;
                    targetPrinterType = printerInfo.tipo;
                    targetPrinterIp = printerInfo.ip;
                    targetPrinterPort = printerInfo.puerto;
                } else if (printerKey === 'default') {
                    const defaultPrinters = await fetch('/api/windows_printers').then(res => res.json());
                    if (defaultPrinters && defaultPrinters.length > 0) {
                        targetPrinterName = defaultPrinters[0];
                        targetPrinterType = 'windows';
                    } else {
                        console.error('No se encontró impresora para el grupo default');
                        continue;
                    }
                }

                const printPayload = {
                    text_content: ticketContent,
                    printer_type: targetPrinterType,
                    items_impresos: itemsToPrint.map(item => ({
                        item_id: item.item_id,
                        cantidad: item.cantidad,
                        cantidad_impresa: item.cantidad_impresa
                    }))
                };

                if (targetPrinterType === 'windows') {
                    printPayload.printer_name = targetPrinterName;
                } else if (targetPrinterType === 'red') {
                    printPayload.ip = targetPrinterIp;
                    printPayload.puerto = targetPrinterPort;
                }
                
                const printResponse = await fetch(`/api/print_ticket?comanda_id=${comanda.comanda_id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(printPayload)
                });

                if (!printResponse.ok) {
                    throw new Error(`Error al imprimir: ${printResponse.statusText}`);
                }

                const printData = await printResponse.json();
                if (!printData.success) {
                    throw new Error(printData.message || 'Error al imprimir el ticket');
                }

                // Marcar los productos como impresos en la interfaz
                itemsToPrint.forEach(item => {
                    const originalItem = comanda.items.find(i => i.item_id === item.item_id);
                    if (originalItem) {
                        originalItem.impreso = new Date().toISOString();
                        originalItem.estatus = 'impreso';
                        originalItem.cantidad_impresa = parseInt(originalItem.cantidad);
                    }
                });

                // Mostrar notificación de éxito para cada impresora
                const printerDisplayName = printerInfo ? printerInfo.nombre : 'Impresora predeterminada';
                window.mostrarNotificacion(`Ticket impreso en ${printerDisplayName} (${grupoNombres})`, 'success');

            } catch (error) {
                console.error(`Error al procesar la impresora ${printerKey}:`, error);
                const printerDisplayName = printerInfo ? printerInfo.nombre : 'Impresora predeterminada';
                window.mostrarNotificacion(`Error al imprimir en ${printerDisplayName}: ${error.message}`, 'danger');
            }
        }

        // Actualizar la vista después de imprimir
        actualizarVistaComanda();
        
        // Actualizar el estado de las mesas
        await actualizarEstadoMesas();

        // Si es totalización, proceder a cerrar comanda
        if (esTotalizacion) {
            try {
                const response = await fetch('/api/comandas/' + comanda.comanda_id + '/pagar', {
                    method: 'PUT'
                });
                const data = await response.json();
                
                if (data.success) {
                    // Limpiar la comanda actual
                    comanda = {
                        mesa_id: null,
                        comanda_id: null,
                        items: [],
                        total: 0,
                        servicio: 'local'
                    };
                    
                    // Limpiar la interfaz
                    document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
                    document.getElementById('detalle-comanda').innerHTML = '';
                    document.getElementById('total-comanda').textContent = '$0.00';
                    document.getElementById('servicio-tipo').value = 'local';
                    
                    // Deshabilitar botones
                    document.getElementById('btn-guardar').disabled = true;
                    document.getElementById('btn-imprimir').disabled = true;
                    document.getElementById('btn-totalizar').disabled = true;
                    document.getElementById('btn-cerrar').disabled = true;
                    
                    // Mostrar el modal de selección de mesa
                    const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
                    modalMesas.show();
                } else {
                    throw new Error(data.error || 'Error desconocido al cerrar la comanda');
                }
            } catch (error) {
                console.error('Error al cerrar comanda:', error);
                window.mostrarNotificacion('Error al cerrar comanda: ' + error.message, 'danger');
            }
        } else {
            // Si no es totalización, limpiar la pantalla después de imprimir exitosamente
            console.log('Impresión completada, limpiando pantalla...'); // Debug
            
            // Limpiar la comanda actual
            comanda = {
                mesa_id: null,
                comanda_id: null,
                items: [],
                total: 0,
                servicio: 'local'
            };
            
            // Limpiar la interfaz
            document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
            document.getElementById('detalle-comanda').innerHTML = '';
            document.getElementById('total-comanda').textContent = '$0.00';
            document.getElementById('servicio-tipo').value = 'local';
            
            // Deshabilitar botones
            document.getElementById('btn-guardar').disabled = true;
            document.getElementById('btn-imprimir').disabled = true;
            document.getElementById('btn-totalizar').disabled = true;
            document.getElementById('btn-cerrar').disabled = true;
            
            // Mostrar notificación de éxito
            window.mostrarNotificacion('Comanda impresa y guardada correctamente. Pantalla limpiada.', 'success');
            
            // Actualizar el estado de las mesas para reflejar que la mesa sigue ocupada
            await actualizarEstadoMesas();
            
            // Mostrar el modal de selección de mesa para continuar con otra comanda
            const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
            modalMesas.show();
        }

    } catch (error) {
        console.error('Error general en la impresión:', error);
        window.mostrarNotificacion('Error al imprimir: ' + error.message, 'danger');
    } finally {
        mostrarCarga('btn-imprimir', 'Imprimir Comanda', false);
    }
}

async function totalizarComanda() {
    if (!comanda || !comanda.items || comanda.items.length === 0) {
        alert('No hay productos en la comanda para totalizar.');
        return;
    }

    if (confirm('¿Está seguro de totalizar y cerrar la comanda?')) {
        try {
            mostrarCarga('btn-totalizar', 'Procesando...', true);
            
            // 1. PRIMERO: Guardar la comanda si no tiene comanda_id
            if (!comanda.comanda_id) {
                console.log('Guardando comanda antes de totalizar...'); // Debug
                await guardarComandaSinLimpiar();
                console.log('Comanda guardada exitosamente'); // Debug
            }

            // 2. SEGUNDO: Obtener la impresora predeterminada de Windows
            const responsePrinters = await fetch('/api/windows_printers');
            const printers = await responsePrinters.json();
            
            if (!printers || printers.length === 0) {
                alert('No se encontraron impresoras de Windows configuradas.');
                return;
            }
            
            const defaultPrinter = printers[0]; // Usar la primera impresora como predeterminada
            
            // 3. TERCERO: Generar el contenido del ticket
            const generateTicketResponse = await fetch('/api/generar_ticket_plain_text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mesa_nombre: document.getElementById('mesa-seleccionada').textContent,
                    items: comanda.items.map(item => ({ 
                        nombre: item.nombre, 
                        cantidad: item.cantidad, 
                        precio: item.precio 
                    })),
                    es_totalizacion: true
                })
            });
            
            const generateTicketData = await generateTicketResponse.json();
            if (!generateTicketData.success) {
                throw new Error(generateTicketData.message || 'Error al generar el ticket');
            }

            // 4. CUARTO: Imprimir el ticket
            const printResponse = await fetch('/api/print_ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text_content: generateTicketData.ticket_content,
                    printer_type: 'windows',
                    printer_name: defaultPrinter
                })
            });
            
            const printData = await printResponse.json();
            if (!printData.success) {
                throw new Error(printData.message || 'Error al imprimir el ticket');
            }

            // 5. QUINTO: Marcar la comanda como pagada
            const response = await fetch(`/api/comandas/${comanda.comanda_id}/pagar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || data.message || `Error del servidor: ${response.status}`);
            }
            
            if (data.success) {
                // Actualizar el estado visual de la mesa
                const mesaCard = document.querySelector(`.mesa-card[data-id="${comanda.mesa_id}"]`);
                if (mesaCard) {
                    mesaCard.classList.remove('bg-success', 'bg-warning');
                    mesaCard.classList.add('bg-success');
                    mesaCard.querySelector('.card-text').textContent = 'Libre';
                    mesaCard.dataset.estatus = 'libre';
                }
                
                // Actualizar el estado de todas las mesas
                await actualizarEstadoMesas();
                
                window.mostrarNotificacion('Comanda totalizada y cerrada correctamente. Pantalla limpiada.', 'success');
                
                // Limpiar la comanda actual
                comanda = {
                    mesa_id: null,
                    comanda_id: null,
                    items: [],
                    total: 0,
                    servicio: 'local'
                };
                
                // Limpiar la interfaz
                document.getElementById('mesa-seleccionada').textContent = 'Ninguna';
                document.getElementById('detalle-comanda').innerHTML = '';
                document.getElementById('total-comanda').textContent = '$0.00';
                document.getElementById('servicio-tipo').value = 'local';
                
                // Deshabilitar botones
                document.getElementById('btn-guardar').disabled = true;
                document.getElementById('btn-imprimir').disabled = true;
                document.getElementById('btn-totalizar').disabled = true;
                document.getElementById('btn-cerrar').disabled = true;
                
                // Mostrar el modal de selección de mesa
                const modalMesas = new bootstrap.Modal(document.getElementById('modalMesas'));
                modalMesas.show();
            } else {
                throw new Error(data.error || 'Error desconocido al cerrar la comanda');
            }
        } catch (error) {
            console.error('Error:', error);
            window.mostrarNotificacion('Error al totalizar la comanda: ' + error.message, 'danger');
        } finally {
            mostrarCarga('btn-totalizar', 'Totalizar y Cerrar', false);
        }
    }
}

// Función para mostrar el modal de productos
function mostrarModalProductos(grupoId) {
    console.log('Mostrando modal para grupo:', grupoId); // Debug
    
    const modalId = `modalGrupo${grupoId}`;
    const modal = document.getElementById(modalId);
    
    if (!modal) {
        console.error(`Modal no encontrado: ${modalId}`);
        return;
    }
    
    // Configurar el modal antes de mostrarlo
    modal.setAttribute('aria-hidden', 'false');
    modal.setAttribute('inert', 'false');
    
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Agregar evento para manejar el cierre del modal
    modal.addEventListener('hidden.bs.modal', function () {
        // Restaurar atributos cuando el modal se cierra
        modal.setAttribute('aria-hidden', 'true');
        modal.setAttribute('inert', 'true');
    });
}

// Función para cerrar el modal de productos
function cerrarModalProductos(grupoId) {
    const modalId = `modalGrupo${grupoId}`;
    const modal = document.getElementById(modalId);
    
    if (!modal) {
        console.error(`Modal no encontrado: ${modalId}`);
        return;
    }
    
    const modalInstance = bootstrap.Modal.getInstance(modal);
    if (modalInstance) {
        modalInstance.hide();
    }
}

// Función para actualizar el estado de las mesas
async function actualizarEstadoMesas() {
    try {
        console.log('Actualizando estado de mesas...'); // Debug
        
        // Hacer una petición al servidor para obtener el estado actual de las mesas
        const response = await fetch('/mesas');
        const html = await response.text();
        
        // Crear un DOM temporal para extraer la información de las mesas
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Obtener las mesas del HTML
        const mesasActualizadas = doc.querySelectorAll('.mesa-card');
        
        // Actualizar cada mesa en el modal
        mesasActualizadas.forEach(mesaActualizada => {
            const mesaId = mesaActualizada.dataset.id;
            const mesaEstatus = mesaActualizada.dataset.estatus;
            const mesaNombre = mesaActualizada.dataset.nombre;
            
            // Buscar la mesa correspondiente en el modal actual
            const mesaEnModal = document.querySelector(`.mesa-card[data-id="${mesaId}"]`);
            if (mesaEnModal) {
                // Actualizar el estatus
                mesaEnModal.dataset.estatus = mesaEstatus;
                
                // Actualizar las clases CSS
                mesaEnModal.classList.remove('bg-success', 'bg-warning', 'text-white');
                if (mesaEstatus === 'libre') {
                    mesaEnModal.classList.add('bg-success', 'text-white');
                } else if (mesaEstatus === 'ocupada') {
                    mesaEnModal.classList.add('bg-warning');
                }
                
                // Actualizar el texto del estatus
                const cardText = mesaEnModal.querySelector('.card-text');
                if (cardText) {
                    cardText.textContent = mesaEstatus.charAt(0).toUpperCase() + mesaEstatus.slice(1);
                }
                
                console.log(`Mesa ${mesaNombre} actualizada a: ${mesaEstatus}`); // Debug
            }
        });
        
        console.log('Estado de mesas actualizado correctamente'); // Debug
        
    } catch (error) {
        console.error('Error al actualizar estado de mesas:', error);
    }
}
</script>
{% endblock %}
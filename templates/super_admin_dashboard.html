<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Administrador - Sistema de Comandas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        .main-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        .nav-link {
            color: #333;
            border-radius: 10px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar min-vh-100 p-3">
                <div class="text-center mb-4">
                    <h4 class="text-primary fw-bold">
                        <i class="fas fa-crown me-2"></i>Super Admin
                    </h4>
                    <p class="text-muted small">{{ usuario.nombre_completo }}</p>
                </div>
                
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" onclick="loadContent('dashboard')">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    <a class="nav-link" href="#" onclick="loadContent('empresas')">
                        <i class="fas fa-building me-2"></i>Gestionar Empresas
                    </a>
                    <a class="nav-link" href="#" onclick="loadContent('solicitudes')">
                        <i class="fas fa-clipboard-list me-2"></i>Solicitudes Pendientes
                    </a>
                    <a class="nav-link" href="#" onclick="loadContent('reportes')">
                        <i class="fas fa-chart-bar me-2"></i>Reportes Globales
                    </a>
                    <hr>
                    <a class="nav-link text-danger" href="{{ url_for('logout') }}">
                        <i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n
                    </a>
                </nav>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9 col-lg-10">
                <div class="main-content">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="text-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>Panel de Super Administraci√≥n
                        </h2>
                        <div class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            <span id="current-time"></span>
                        </div>
                    </div>
                    
                    <!-- Content Area -->
                    <div id="content-area">
                        <!-- Dashboard Content -->
                        <div id="dashboard-content">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-building fa-2x mb-2"></i>
                                            <h3 id="total-empresas">0</h3>
                                            <p class="mb-0">Empresas Registradas</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-clock fa-2x mb-2"></i>
                                            <h3 id="empresas-pendientes">0</h3>
                                            <p class="mb-0">Pendientes de Aprobaci√≥n</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                                            <h3 id="empresas-activas">0</h3>
                                            <p class="mb-0">Empresas Activas</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card stats-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users fa-2x mb-2"></i>
                                            <h3 id="total-usuarios">0</h3>
                                            <p class="mb-0">Usuarios Totales</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-chart-pie me-2"></i>Estad√≠sticas de Empresas</h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="empresasChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-list me-2"></i>√öltimas Solicitudes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="ultimas-solicitudes">
                                                <p class="text-muted">Cargando...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other content areas will be loaded here -->
                        <div id="empresas-content" style="display: none;"></div>
                        <div id="solicitudes-content" style="display: none;"></div>
                        <div id="reportes-content" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para rechazar empresa -->
    <div class="modal fade" id="rechazarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rechazar Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¬øEst√° seguro de que desea rechazar esta empresa?</p>
                    <div class="mb-3">
                        <label for="comentarios" class="form-label">Comentarios (opcional):</label>
                        <textarea class="form-control" id="comentarios" rows="3" placeholder="Explique el motivo del rechazo..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarRechazar()">Rechazar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de empresa -->
    <div class="modal fade" id="detallesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles de la Empresa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalles-empresa-content">
                    <!-- Contenido cargado din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('es-ES');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Load dashboard stats
        function loadDashboardStats() {
            fetch('/api/super-admin/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Actualizar estad√≠sticas
                        document.getElementById('total-empresas').textContent = data.stats.total_empresas || 0;
                        document.getElementById('empresas-pendientes').textContent = data.stats.empresas_pendientes || 0;
                        document.getElementById('empresas-activas').textContent = data.stats.empresas_activas || 0;
                        document.getElementById('total-usuarios').textContent = data.stats.total_usuarios || 0;
                        
                        // Actualizar gr√°fico solo si hay datos v√°lidos
                        if (data.stats && (data.stats.empresas_activas > 0 || data.stats.empresas_pendientes > 0 || data.stats.empresas_inactivas > 0)) {
                        updateEmpresasChart(data.stats);
                        }
                    } else {
                        console.error('Error en la respuesta de stats:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    // Mostrar valores por defecto en caso de error
                    document.getElementById('total-empresas').textContent = '0';
                    document.getElementById('empresas-pendientes').textContent = '0';
                    document.getElementById('empresas-activas').textContent = '0';
                    document.getElementById('total-usuarios').textContent = '0';
                });
        }

        // Load latest requests
        function loadLatestRequests() {
            fetch('/api/super-admin/solicitudes/recientes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('ultimas-solicitudes');
                        if (data.solicitudes.length === 0) {
                            container.innerHTML = '<p class="text-muted">No hay solicitudes recientes</p>';
                            return;
                        }
                        
                        let html = '';
                        data.solicitudes.forEach(solicitud => {
                            const statusClass = solicitud.estatus === 'pendiente' ? 'warning' : 
                                               solicitud.estatus === 'aprobada' ? 'success' : 'danger';
                            const statusIcon = solicitud.estatus === 'pendiente' ? 'clock' : 
                                              solicitud.estatus === 'aprobada' ? 'check' : 'times';
                            
                            html += `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong>${solicitud.nombre_empresa || 'Empresa sin nombre'}</strong>
                                        <br>
                                        <small class="text-muted">${solicitud.fecha_solicitud || 'Fecha no disponible'}</small>
                                    </div>
                                    <span class="badge bg-${statusClass}">
                                        <i class="fas fa-${statusIcon} me-1"></i>${solicitud.estatus || 'Desconocido'}
                                    </span>
                                </div>
                            `;
                        });
                        container.innerHTML = html;
                    } else {
                        console.error('Error en la respuesta de solicitudes:', data.message);
                        document.getElementById('ultimas-solicitudes').innerHTML = '<p class="text-muted">Error al cargar solicitudes</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading requests:', error);
                    document.getElementById('ultimas-solicitudes').innerHTML = '<p class="text-muted">Error al cargar solicitudes</p>';
                });
        }

        // Update empresas chart
        function updateEmpresasChart(stats) {
            const ctx = document.getElementById('empresasChart').getContext('2d');
            
            // Verificar si el gr√°fico existe y es v√°lido antes de destruirlo
            if (window.empresasChart && typeof window.empresasChart.destroy === 'function') {
                window.empresasChart.destroy();
            }
            
            // Verificar que el canvas existe
            if (!ctx) {
                console.error('No se pudo obtener el contexto del canvas');
                return;
            }
            
            try {
            window.empresasChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Activas', 'Pendientes', 'Inactivas'],
                    datasets: [{
                        data: [stats.empresas_activas, stats.empresas_pendientes, stats.empresas_inactivas],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            } catch (error) {
                console.error('Error al crear el gr√°fico:', error);
            }
        }

        // Load content function
        function loadContent(section) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // Hide all content areas
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('empresas-content').style.display = 'none';
            document.getElementById('solicitudes-content').style.display = 'none';
            document.getElementById('reportes-content').style.display = 'none';
            
            // Show selected content
            if (section === 'dashboard') {
                document.getElementById('dashboard-content').style.display = 'block';
                loadDashboardStats();
                loadLatestRequests();
            } else if (section === 'empresas') {
                document.getElementById('empresas-content').style.display = 'block';
                loadEmpresasContent();
            } else if (section === 'solicitudes') {
                document.getElementById('solicitudes-content').style.display = 'block';
                loadSolicitudesContent();
            } else if (section === 'reportes') {
                document.getElementById('reportes-content').style.display = 'block';
                loadReportesContent();
            }
        }

        // Load empresas content
        function loadEmpresasContent() {
            fetch('/super-admin/empresas')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('empresas-content').innerHTML = html;
                    
                    // Ejecutar el JavaScript despu√©s de cargar el HTML
                    console.log('üîÑ HTML de empresas cargado, configurando event listeners...');
                    
                    // Configurar event listeners para los botones
                    setTimeout(() => {
                        // Bot√≥n aprobar empresa
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-aprobar')) {
                                console.log('‚úÖ Bot√≥n aprobar clickeado');
                                const empresaId = e.target.closest('.btn-aprobar').getAttribute('data-empresa-id');
                                console.log('Empresa ID:', empresaId);
                                aprobarEmpresa(empresaId);
                            }
                        });

                        // Bot√≥n rechazar empresa
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-rechazar')) {
                                console.log('‚úÖ Bot√≥n rechazar clickeado');
                                const empresaId = e.target.closest('.btn-rechazar').getAttribute('data-empresa-id');
                                console.log('Empresa ID:', empresaId);
                                rechazarEmpresa(empresaId);
                            }
                        });

                        // Bot√≥n ver detalles
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-detalles')) {
                                console.log('‚úÖ Bot√≥n detalles clickeado');
                                const empresaId = e.target.closest('.btn-detalles').getAttribute('data-empresa-id');
                                console.log('Empresa ID:', empresaId);
                                verDetallesEmpresa(empresaId);
                            }
                        });

                        // Bot√≥n toggle status
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-toggle-status')) {
                                console.log('‚úÖ Bot√≥n toggle status clickeado');
                                const button = e.target.closest('.btn-toggle-status');
                                const empresaId = button.getAttribute('data-empresa-id');
                                const currentStatus = button.getAttribute('data-estatus');
                                console.log('Empresa ID:', empresaId, 'Status:', currentStatus);
                                toggleEmpresaStatus(empresaId, currentStatus);
                            }
                        });
                        
                        console.log('‚úÖ Event listeners configurados para empresas');
                    }, 100);
                })
                .catch(error => console.error('Error loading empresas:', error));
        }

        // Load solicitudes content
        function loadSolicitudesContent() {
            fetch('/super-admin/solicitudes')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('solicitudes-content').innerHTML = html;
                    
                    // Cargar datos iniciales
                    loadSolicitudesStats();
                    loadSolicitudesData();
                    
                    // Configurar event listeners para los botones
                    setTimeout(() => {
                        // Bot√≥n ver detalles de solicitud
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-detalles-solicitud')) {
                                const solicitudId = e.target.closest('.btn-detalles-solicitud').getAttribute('data-solicitud-id');
                                verDetallesSolicitud(solicitudId);
                            }
                        });

                        // Bot√≥n aprobar solicitud
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-aprobar-solicitud')) {
                                const solicitudId = e.target.closest('.btn-aprobar-solicitud').getAttribute('data-solicitud-id');
                                aprobarSolicitud(solicitudId);
                            }
                        });

                        // Bot√≥n rechazar solicitud
                        document.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-rechazar-solicitud')) {
                                const solicitudId = e.target.closest('.btn-rechazar-solicitud').getAttribute('data-solicitud-id');
                                rechazarSolicitud(solicitudId);
                            }
                        });
                        
                        console.log('‚úÖ Event listeners configurados para solicitudes');
                    }, 100);
                })
                .catch(error => console.error('Error loading solicitudes:', error));
        }

        // Load reportes content
        function loadReportesContent() {
            document.getElementById('reportes-content').innerHTML = `
                <div class="text-center">
                    <h4>Reportes Globales</h4>
                    <p class="text-muted">Contenido en desarrollo...</p>
                </div>
            `;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadLatestRequests();
        });

        // Funciones para gesti√≥n de empresas
        let empresaIdRechazar = null;

        function refreshEmpresas() {
            console.log('üîÑ Recargando empresas...');
            loadEmpresasContent();
        }

        function aprobarEmpresa(empresaId) {
            console.log('üöÄ Aprobando empresa:', empresaId);
            if (confirm('¬øEst√° seguro de que desea aprobar esta empresa?')) {
                fetch(`/api/super-admin/empresas/${empresaId}/aprobar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        showAlert('Empresa aprobada exitosamente', 'success');
                        refreshEmpresas();
                        loadDashboardStats(); // Actualizar estad√≠sticas
                    } else {
                        showAlert(data.message || 'Error al aprobar empresa', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error de conexi√≥n', 'danger');
                });
            }
        }

        function rechazarEmpresa(empresaId) {
            console.log('‚ùå Rechazando empresa:', empresaId);
            empresaIdRechazar = empresaId;
            const modal = new bootstrap.Modal(document.getElementById('rechazarModal'));
            modal.show();
        }

        function confirmarRechazar() {
            if (!empresaIdRechazar) return;
            
            const comentarios = document.getElementById('comentarios').value;
            console.log('üö´ Confirmando rechazo para empresa:', empresaIdRechazar);
            
            fetch(`/api/super-admin/empresas/${empresaIdRechazar}/rechazar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comentarios: comentarios })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    showAlert('Empresa rechazada exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('rechazarModal')).hide();
                    document.getElementById('comentarios').value = '';
                    empresaIdRechazar = null;
                    refreshEmpresas();
                    loadDashboardStats(); // Actualizar estad√≠sticas
                } else {
                    showAlert(data.message || 'Error al rechazar empresa', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'danger');
            });
        }

        function verDetallesEmpresa(empresaId) {
            console.log('üëÅÔ∏è Ver detalles empresa:', empresaId);
            fetch(`/api/super-admin/empresas/${empresaId}/detalles`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        const empresa = data.empresa;
                        const solicitud = data.solicitud;
                        
                        let html = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Informaci√≥n de la Empresa</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Nombre:</strong></td><td>${empresa.nombre_empresa}</td></tr>
                                        <tr><td><strong>C√≥digo:</strong></td><td>${empresa.codigo_empresa}</td></tr>
                                        <tr><td><strong>Email:</strong></td><td>${empresa.email}</td></tr>
                                        <tr><td><strong>Tel√©fono:</strong></td><td>${empresa.telefono || 'N/A'}</td></tr>
                                        <tr><td><strong>RIF:</strong></td><td>${empresa.rif}</td></tr>
                                        <tr><td><strong>Direcci√≥n:</strong></td><td>${empresa.direccion || 'N/A'}</td></tr>
                                        <tr><td><strong>Estatus:</strong></td><td>
                                            ${empresa.estatus === 'activo' ? '<span class="badge bg-success">Activa</span>' : 
                                              empresa.estatus === 'en_espera' ? '<span class="badge bg-warning">En Espera</span>' : 
                                              '<span class="badge bg-danger">Inactiva</span>'}
                                        </td></tr>
                                        <tr><td><strong>Fecha Registro:</strong></td><td>${empresa.fecha_registro || 'N/A'}</td></tr>
                                        ${empresa.fecha_aprobacion ? `<tr><td><strong>Fecha Aprobaci√≥n:</strong></td><td>${empresa.fecha_aprobacion}</td></tr>` : ''}
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Informaci√≥n de la Solicitud</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Estatus:</strong></td><td>
                                            ${solicitud.estatus === 'pendiente' ? '<span class="badge bg-warning">Pendiente</span>' : 
                                              solicitud.estatus === 'aprobada' ? '<span class="badge bg-success">Aprobada</span>' : 
                                              '<span class="badge bg-danger">Rechazada</span>'}
                                        </td></tr>
                                        <tr><td><strong>Fecha Solicitud:</strong></td><td>${solicitud.fecha_solicitud || 'N/A'}</td></tr>
                                        ${solicitud.fecha_revision ? `<tr><td><strong>Fecha Revisi√≥n:</strong></td><td>${solicitud.fecha_revision}</td></tr>` : ''}
                                        ${solicitud.comentarios ? `<tr><td><strong>Comentarios:</strong></td><td>${solicitud.comentarios}</td></tr>` : ''}
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('detalles-empresa-content').innerHTML = html;
                        const modal = new bootstrap.Modal(document.getElementById('detallesModal'));
                        modal.show();
                    } else {
                        showAlert('Error al cargar detalles', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error de conexi√≥n', 'danger');
                });
        }

        function toggleEmpresaStatus(empresaId, currentStatus) {
            const newStatus = currentStatus === 'activo' ? 'inactivo' : 'activo';
            const action = newStatus === 'activo' ? 'activar' : 'desactivar';
            
            console.log('üîÑ Toggle status empresa:', empresaId, 'de', currentStatus, 'a', newStatus);
            
            if (confirm(`¬øEst√° seguro de que desea ${action} esta empresa?`)) {
                fetch(`/api/super-admin/empresas/${empresaId}/toggle-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estatus: newStatus })
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        showAlert(`Empresa ${action}da exitosamente`, 'success');
                        refreshEmpresas();
                        loadDashboardStats(); // Actualizar estad√≠sticas
                    } else {
                        showAlert(data.message || `Error al ${action} empresa`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error de conexi√≥n', 'danger');
                });
            }
        }

        function showAlert(message, type) {
            console.log('üì¢ Mostrando alerta:', message, type);
            // Crear alerta temporal
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Funciones para gesti√≥n de solicitudes
        let solicitudIdActual = null;

        function refreshSolicitudes() {
            console.log('üîÑ Recargando solicitudes...');
            loadSolicitudesStats();
            loadSolicitudesData();
        }

        function loadSolicitudesStats() {
            fetch('/api/super-admin/solicitudes/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        document.getElementById('total-solicitudes').textContent = stats.total_solicitudes;
                        document.getElementById('solicitudes-pendientes').textContent = stats.solicitudes_pendientes;
                        document.getElementById('solicitudes-aprobadas').textContent = stats.solicitudes_aprobadas;
                        document.getElementById('solicitudes-rechazadas').textContent = stats.solicitudes_rechazadas;
                    }
                })
                .catch(error => console.error('Error loading solicitudes stats:', error));
        }

        function loadSolicitudesData(estatus = 'todas') {
            fetch(`/api/super-admin/solicitudes?estatus=${estatus}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderSolicitudesTable(data.solicitudes);
                    } else {
                        console.error('Error loading solicitudes:', data.message);
                    }
                })
                .catch(error => console.error('Error loading solicitudes:', error));
        }

        function renderSolicitudesTable(solicitudes) {
            const tbody = document.getElementById('solicitudes-table-body');
            const noSolicitudes = document.getElementById('no-solicitudes');
            
            if (!solicitudes || solicitudes.length === 0) {
                tbody.innerHTML = '';
                noSolicitudes.style.display = 'block';
                return;
            }
            
            noSolicitudes.style.display = 'none';
            
            tbody.innerHTML = solicitudes.map(solicitud => `
                <tr>
                    <td>
                        <strong>${solicitud.nombre_empresa}</strong>
                        <br><small class="text-muted">${solicitud.codigo_empresa}</small>
                    </td>
                    <td>${solicitud.email}</td>
                    <td>${solicitud.rif}</td>
                    <td>
                        ${solicitud.estatus === 'pendiente' ? 
                            '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pendiente</span>' : 
                          solicitud.estatus === 'aprobada' ? 
                            '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Aprobada</span>' : 
                            '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Rechazada</span>'}
                    </td>
                    <td>
                        <small>${solicitud.fecha_solicitud || 'N/A'}</small>
                    </td>
                    <td>
                        <small>${solicitud.fecha_revision || 'N/A'}</small>
                    </td>
                    <td>
                        <small>${solicitud.revisor_nombre || 'N/A'}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            ${solicitud.estatus === 'pendiente' ? `
                                <button class="btn btn-success btn-sm btn-aprobar-solicitud" 
                                        data-solicitud-id="${solicitud.id}" 
                                        title="Aprobar">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-danger btn-sm btn-rechazar-solicitud" 
                                        data-solicitud-id="${solicitud.id}" 
                                        title="Rechazar">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-info btn-sm btn-detalles-solicitud" 
                                    data-solicitud-id="${solicitud.id}" 
                                    title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterSolicitudes(estatus) {
            console.log('üîç Filtrando solicitudes por estatus:', estatus);
            loadSolicitudesData(estatus);
        }

        function verDetallesSolicitud(solicitudId) {
            console.log('üëÅÔ∏è Ver detalles solicitud:', solicitudId);
            fetch(`/api/super-admin/solicitudes/${solicitudId}/detalles`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const solicitud = data.solicitud;
                        
                        let html = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Informaci√≥n de la Empresa</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Nombre:</strong></td><td>${solicitud.nombre_empresa}</td></tr>
                                        <tr><td><strong>C√≥digo:</strong></td><td>${solicitud.codigo_empresa}</td></tr>
                                        <tr><td><strong>Email:</strong></td><td>${solicitud.email}</td></tr>
                                        <tr><td><strong>Tel√©fono:</strong></td><td>${solicitud.telefono || 'N/A'}</td></tr>
                                        <tr><td><strong>RIF:</strong></td><td>${solicitud.rif}</td></tr>
                                        <tr><td><strong>Direcci√≥n:</strong></td><td>${solicitud.direccion || 'N/A'}</td></tr>
                                        <tr><td><strong>Estatus Empresa:</strong></td><td>
                                            ${solicitud.estatus === 'activo' ? '<span class="badge bg-success">Activa</span>' : 
                                              solicitud.estatus === 'en_espera' ? '<span class="badge bg-warning">En Espera</span>' : 
                                              '<span class="badge bg-danger">Inactiva</span>'}
                                        </td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Informaci√≥n de la Solicitud</h6>
                                    <table class="table table-sm">
                                        <tr><td><strong>Estatus:</strong></td><td>
                                            ${solicitud.estatus === 'pendiente' ? '<span class="badge bg-warning">Pendiente</span>' : 
                                              solicitud.estatus === 'aprobada' ? '<span class="badge bg-success">Aprobada</span>' : 
                                              '<span class="badge bg-danger">Rechazada</span>'}
                                        </td></tr>
                                        <tr><td><strong>Fecha Solicitud:</strong></td><td>${solicitud.fecha_solicitud || 'N/A'}</td></tr>
                                        ${solicitud.fecha_revision ? `<tr><td><strong>Fecha Revisi√≥n:</strong></td><td>${solicitud.fecha_revision}</td></tr>` : ''}
                                        ${solicitud.revisor_nombre ? `<tr><td><strong>Revisor:</strong></td><td>${solicitud.revisor_nombre}</td></tr>` : ''}
                                        ${solicitud.comentarios ? `<tr><td><strong>Comentarios:</strong></td><td>${solicitud.comentarios}</td></tr>` : ''}
                                    </table>
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('detalles-solicitud-content').innerHTML = html;
                        const modal = new bootstrap.Modal(document.getElementById('detallesSolicitudModal'));
                        modal.show();
                    } else {
                        showAlert('Error al cargar detalles', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error de conexi√≥n', 'danger');
                });
        }

        function aprobarSolicitud(solicitudId) {
            console.log('üöÄ Aprobando solicitud:', solicitudId);
            solicitudIdActual = solicitudId;
            const modal = new bootstrap.Modal(document.getElementById('aprobarSolicitudModal'));
            modal.show();
        }

        function confirmarAprobarSolicitud() {
            if (!solicitudIdActual) return;
            
            const comentarios = document.getElementById('comentarios-aprobacion').value;
            console.log('‚úÖ Confirmando aprobaci√≥n para solicitud:', solicitudIdActual);
            
            fetch(`/api/super-admin/solicitudes/${solicitudIdActual}/aprobar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comentarios: comentarios })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Solicitud aprobada exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('aprobarSolicitudModal')).hide();
                    document.getElementById('comentarios-aprobacion').value = '';
                    solicitudIdActual = null;
                    refreshSolicitudes();
                    loadDashboardStats(); // Actualizar estad√≠sticas del dashboard
                } else {
                    showAlert(data.message || 'Error al aprobar solicitud', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'danger');
            });
        }

        function rechazarSolicitud(solicitudId) {
            console.log('‚ùå Rechazando solicitud:', solicitudId);
            solicitudIdActual = solicitudId;
            const modal = new bootstrap.Modal(document.getElementById('rechazarSolicitudModal'));
            modal.show();
        }

        function confirmarRechazarSolicitud() {
            if (!solicitudIdActual) return;
            
            const comentarios = document.getElementById('comentarios-rechazo').value;
            if (!comentarios.trim()) {
                showAlert('Los comentarios son obligatorios para rechazar una solicitud', 'warning');
                return;
            }
            
            console.log('üö´ Confirmando rechazo para solicitud:', solicitudIdActual);
            
            fetch(`/api/super-admin/solicitudes/${solicitudIdActual}/rechazar`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ comentarios: comentarios })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Solicitud rechazada exitosamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('rechazarSolicitudModal')).hide();
                    document.getElementById('comentarios-rechazo').value = '';
                    solicitudIdActual = null;
                    refreshSolicitudes();
                    loadDashboardStats(); // Actualizar estad√≠sticas del dashboard
                } else {
                    showAlert(data.message || 'Error al rechazar solicitud', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Error de conexi√≥n', 'danger');
            });
        }
    </script>
</body>
</html> 
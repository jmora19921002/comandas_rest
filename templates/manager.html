{% extends "base.html" %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}
<!-- Botón para mostrar/ocultar sidebar en móviles -->
<button class="sidebar-toggle d-md-none" type="button">
    <i class="bi bi-list"></i>
</button>

<!-- Overlay para móviles -->
<div class="sidebar-overlay"></div>

<!-- Sidebar -->
<div class="sidebar">
    <div class="d-flex flex-column h-100">
        <h4 class="text-center mb-4 text-white">Menú Principal</h4>
        <ul class="nav flex-column">
            {% if session.rol != 'soporte' %}
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="cargarSeccion('dashboard', this); return false;">
                    <i class="bi bi-speedometer"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="cargarSeccion('comandas', this); return false;">
                    <i class="bi bi-receipt"></i> Comandas
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="cargarSeccion('ventas', this); return false;">
                    <i class="bi bi-graph-up"></i> Ventas por Ítem
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="cargarSeccion('items', this); return false;">
                    <i class="bi bi-cup-straw"></i> Items
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="cargarSeccion('grupos', this); return false;">
                    <i class="bi bi-collection"></i> Grupos
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="cargarSeccion('mesas', this); return false;">
                    <i class="bi bi-table"></i> Mesas
                </a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownInventario" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-boxes"></i> Inventario Completo
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDropdownInventario">
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('inventario/productos', this); return false;">
                        <i class="bi bi-box"></i> Productos
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('inventario/compras', this); return false;">
                        <i class="bi bi-cart-plus"></i> Compras
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('inventario/recetas', this); return false;">
                        <i class="bi bi-journal-text"></i> Recetas
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('inventario/produccion', this); return false;">
                        <i class="bi bi-gear"></i> Producción
                    </a></li>
                </ul>
            </li>
            {% endif %}
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownSistema" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear"></i> Sistema
                </a>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDropdownSistema">
                    {% if session.rol == 'soporte' %}
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('empresa', this); return false;">
                        <i class="bi bi-building"></i> Empresa
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('backup', this); return false;">
                        <i class="bi bi-database-down"></i> Respaldo de Base de Datos
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('actualizar-estructura', this); return false;">
                        <i class="bi bi-arrow-up-circle"></i> Actualizar Estructura
                    </a></li>
                    {% else %}
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('usuarios', this); return false;">Usuarios</a></li>
                    <li><a class="dropdown-item" href="#" onclick="cargarSeccion('impresoras', this); return false;">Impresoras</a></li>
                    {% endif %}
                </ul>
            </li>
        </ul>

        <div class="mt-auto p-3">
            <div class="stats-card">
                <h4>Bienvenido</h4>
                <div class="number">{{ usuario.nombre_completo }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Contenido principal -->
<div class="main-content">
    <div id="contenido-seccion">
        <!-- El contenido de cada sección se cargará aquí dinámicamente -->
        <div class="card">
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Seleccione una sección del menú lateral para comenzar
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para formularios -->
<div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Formulario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- El formulario se cargará aquí -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="modalSaveBtn" onclick="guardarFormulario()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para manejar el sidebar en móviles
function toggleSidebar() {
    console.log('Toggle sidebar clicked'); // Debug
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('show');
        console.log('Sidebar classes:', sidebar.classList); // Debug
    }
}

// Función para cargar las diferentes secciones
function cargarSeccion(seccion, link = null) {
    // Actualizar clase activa en el menú
    document.querySelectorAll('.nav-link').forEach(navLink => {
        navLink.classList.remove('active');
    });
    if (link) {
        link.classList.add('active');
    }

    // Cerrar sidebar en móviles después de seleccionar una sección
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }

    // Mostrar indicador de carga
    document.getElementById('contenido-seccion').innerHTML = `
        <div class="card">
            <div class="card-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando contenido...</p>
            </div>
        </div>
    `;

    // Cargar el contenido de la sección
    fetch(`/manager/${seccion}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('contenido-seccion').innerHTML = html;
            
            // Inicializar eventos específicos según la sección
            if (seccion === 'comandas') {
                inicializarComandas();
            } else if (seccion === 'ventas') {
                inicializarVentas();
            } else if (seccion === 'impresoras') {
                // Asegurarse de que el script de impresoras se ejecute
                if (typeof inicializarImpresoras === 'function') {
                    inicializarImpresoras();
                } else {
                    console.warn('inicializarImpresoras function not found.');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('contenido-seccion').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error al cargar la sección
                        </div>
                    </div>
                </div>
            `;
        });
}

// Función para inicializar la sección de comandas
function inicializarComandas() {
    const detalleModal = document.getElementById('detalleComandaModal');
    if (detalleModal) {
        detalleModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('comanda-id').textContent = '';
            document.getElementById('comanda-mesa').textContent = '';
            document.getElementById('comanda-fecha').textContent = '';
            document.getElementById('comanda-total').textContent = '';
            document.getElementById('detalle-comanda-body').innerHTML = '';
        });
    }
}

// Función para inicializar la sección de ventas
function inicializarVentas() {
    // Establecer fechas por defecto (último mes)
    const hoy = new Date();
    const mesAnterior = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
    
    document.getElementById('fecha-inicio').value = mesAnterior.toISOString().split('T')[0];
    document.getElementById('fecha-fin').value = hoy.toISOString().split('T')[0];
    
    // Cargar datos iniciales
    filtrarVentas();
}

// Función para filtrar ventas
function filtrarVentas() {
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;
    
    if (!fechaInicio || !fechaFin) {
        window.mostrarNotificacion('Por favor seleccione ambas fechas', 'warning');
        return;
    }
    
    fetch(`/manager/ventas?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newTableBody = doc.getElementById('ventas-table-body');
            const newTotal = doc.getElementById('total-ventas');
            
            document.getElementById('ventas-table-body').innerHTML = newTableBody.innerHTML;
            document.getElementById('total-ventas').textContent = newTotal.textContent;
        })
        .catch(error => {
            console.error('Error:', error);
            window.mostrarNotificacion('Error al filtrar las ventas', 'danger');
        });
}

// Función para ver comandas de un ítem
function verComandasItem(itemNombre) {
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;
    
    document.getElementById('item-nombre').textContent = itemNombre;
    
    fetch(`/api/ventas-item/comandas?item=${encodeURIComponent(itemNombre)}&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('comandas-item-body');
            tbody.innerHTML = '';
            
            data.comandas.forEach(comanda => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${comanda.id}</td>
                    <td>${comanda.mesa_nombre}</td>
                    <td>${new Date(comanda.fecha).toLocaleString()}</td>
                    <td>${comanda.cantidad}</td>
                    <td>$${comanda.total.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('comandasItemModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            window.mostrarNotificacion('Error al cargar las comandas del ítem', 'danger');
        });
}

// Función para imprimir reporte de ventas
function imprimirReporte() {
    const ventana = window.open('', '_blank');
    const tabla = document.querySelector('.table').cloneNode(true);
    
    // Remover la columna de acciones
    const columnasAccion = tabla.querySelectorAll('th:last-child, td:last-child');
    columnasAccion.forEach(col => col.remove());
    
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;
    
    ventana.document.write(`
        <html>
            <head>
                <title>Reporte de Ventas</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        body { margin: 0; padding: 15px; }
                        .no-print { display: none; }
                    }
                    .reporte {
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    .reporte-header {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                </style>
            </head>
            <body>
                <div class="reporte">
                    <div class="reporte-header">
                        <h4>Sistema de Comandas</h4>
                        <p>Reporte de Ventas por Ítem</p>
                        <p>Período: ${fechaInicio} al ${fechaFin}</p>
                        <p>Fecha de impresión: ${new Date().toLocaleString()}</p>
                    </div>
                    ${tabla.outerHTML}
                    <div class="mt-3">
                        <h5>Total General: $<span id="total-ventas">${document.getElementById('total-ventas').textContent}</span></h5>
                    </div>
                </div>
                <div class="text-center mt-3 no-print">
                    <button onclick="window.print()" class="btn btn-primary">Imprimir</button>
                    <button onclick="window.close()" class="btn btn-secondary">Cerrar</button>
                </div>
            </body>
        </html>
    `);
    ventana.document.close();
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Configurar eventos del sidebar
    const sidebarToggle = document.querySelector('.sidebar-toggle');
    const sidebarOverlay = document.querySelector('.sidebar-overlay');
    
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();
            toggleSidebar();
        });
    }
    
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            toggleSidebar();
        });
    }

    // Cargar sección inicial basada en el rol del usuario
    const userRole = '{{ session.rol }}';
    if (userRole === 'soporte') {
        cargarSeccion('empresa', document.querySelector('.nav-link'));
    } else {
        cargarSeccion('dashboard', document.querySelector('.nav-link.active'));
    }
    
    // Configurar el modal para limpiar su contenido al cerrarse
    const formModal = document.getElementById('formModal');
    if (formModal) {
        formModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('modalBody').innerHTML = '';
        });
    }
});
</script>
{% endblock %}